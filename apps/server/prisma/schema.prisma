// Prisma Schema for RSS Reader
// 使用 SQLite 作为开发数据库

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==================== 用户相关 ====================

/// 用户偏好设置
model UserPreference {
  id        String   @id @default(cuid())
  userId    String   @unique // 用户唯一标识

  // 界面偏好
  theme     String   @default("system") // light, dark, system
  fontSize  String   @default("medium") // small, medium, large
  language  String   @default("zh-CN")

  // 阅读偏好
  defaultView      String @default("unread") // all, unread, starred
  articleListStyle String @default("list") // list, compact, card
  autoMarkRead     Boolean @default(true)
  scrollMode       String @default("infinite") // infinite, pagination

  // 通知偏好
  enableNotifications Boolean @default(false)
  notificationSound   Boolean @default(true)

  // 同步偏好
  autoSync      Boolean @default(true)
  syncInterval  Int     @default(30) // 分钟

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_preferences")
}

/// AI API 密钥配置
model AIApiKey {
  id          String   @id @default(cuid())
  userId      String
  provider    String   // openai, anthropic, google, etc.
  apiKey      String   // 加密存储
  apiEndpoint String?  // 自定义 API 端点
  isActive    Boolean  @default(true)

  // 使用限制
  monthlyLimit Int?    // 每月使用次数限制
  usedCount    Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, provider])
  @@map("ai_api_keys")
}

// ==================== 订阅相关 ====================

/// 分类
model Category {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  color       String?  // 分类颜色 (hex)
  icon        String?  // 分类图标
  sortOrder   Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions Subscription[]

  @@unique([userId, name])
  @@map("categories")
}

/// 订阅源
model Subscription {
  id          String   @id @default(cuid())
  userId      String
  categoryId  String?

  // RSS 基本信息
  title       String
  description String?
  feedUrl     String
  siteUrl     String?
  imageUrl    String?

  // 订阅状态
  isActive    Boolean  @default(true)
  lastFetched DateTime?
  fetchError  String?
  errorCode   String?

  // 配置
  refreshInterval Int?    // 自定义刷新间隔（分钟）
  showImages      Boolean @default(true)
  fullTextExtract Boolean @default(false) // 是否提取全文

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  category Category?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  articles Article[]

  @@unique([userId, feedUrl])
  @@map("subscriptions")
}

// ==================== 文章相关 ====================

/// 文章
model Article {
  id             String   @id @default(cuid())
  subscriptionId String

  // 文章内容
  title          String
  content        String?  // HTML 内容
  contentText    String?  // 纯文本内容
  summary        String?  // AI 生成的摘要
  url            String
  imageUrl       String?
  author         String?

  // 元数据
  publishedAt    DateTime?
  fetchedAt      DateTime  @default(now())

  // 阅读状态
  isRead         Boolean   @default(false)
  isStarred      Boolean   @default(false)
  readProgress   Float     @default(0) // 阅读进度 0-1
  readAt         DateTime?

  // AI 处理
  isAiProcessed  Boolean   @default(false)
  aiTags         String?   // JSON 数组存储 AI 生成的标签
  sentiment      String?   // 情感分析结果

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscription Subscription    @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  obsidianNotes ObsidianNote[]

  @@index([subscriptionId])
  @@index([isRead])
  @@index([isStarred])
  @@index([publishedAt])
  @@map("articles")
}

// ==================== 过滤规则 ====================

/// 过滤规则
model FilterRule {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?

  // 规则配置
  isActive    Boolean  @default(true)
  priority    Int      @default(0) // 优先级，数字越大越先执行

  // 匹配条件
  fieldType   String   // title, content, author, url, category
  matchType   String   // contains, not_contains, equals, regex, starts_with, ends_with
  pattern     String   // 匹配模式
  caseSensitive Boolean @default(false)

  // 匹配后的操作
  action      String   // mark_read, hide, star, delete, move_to_category
  actionValue String?  // 操作的额外值（如移动到的分类 ID）

  // 应用范围
  applyToAll   Boolean  @default(true)
  subscriptionIds String? // JSON 数组存储特定订阅 ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("filter_rules")
}

// ==================== Obsidian 集成 ====================

/// Obsidian 笔记记录
model ObsidianNote {
  id           String   @id @default(cuid())
  articleId    String

  // 笔记信息
  notePath     String   // Obsidian vault 中的文件路径
  noteTitle    String?
  noteContent  String?

  // 同步状态
  syncStatus   String   @default("synced") // synced, pending, failed
  lastSyncedAt DateTime?
  syncError    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([articleId])
  @@map("obsidian_notes")
}
